{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}

<div class="col-md-8 mb-4">
    <!--Card-->
    <div class="card">
        <form class="card-body" method="POST">
            {% csrf_token %}

            <h6 class="px-1">Contact Info</h6>

            <div class="row mb-1">
                <div class="col-md-6">
                        {{ form.first_name |as_crispy_field }}
                </div>
                <div class="col-md-6">
                        {{ form.last_name|as_crispy_field }}
                </div>
            </div>

            <div class="row mb-1">
                <div class="col-md-6">
                        {{ form.email |as_crispy_field }}
                </div>
                <div class="col-md-6">
                        {{ form.phone_number|as_crispy_field }}
                </div>
            </div>
            
            <hr>

            <h6 class="px-1">Shipping Info</h6>

            <div class="row mb-1">
                <!--address-->
                <div class="col-md-6">
                    {{ form.address1 |as_crispy_field }}
                </div>

                <!--address-2-->
                <div class="col-md-6">
                    {{ form.address2 |as_crispy_field }}
                </div>
            </div>

            <div class="mb-1">
                {{ form.country |as_crispy_field }}
            </div>

            <!--Grid row-->
            <div class="row mb-1">
                <div class="col-lg-4 col-md-6">
                    {{ form.city |as_crispy_field }}
                </div>

                <div class="col-lg-4 col-md-6">
                    {{ form.state |as_crispy_field }}
                </div>

                <div class="col-lg-4 col-md-6">
                    {{ form.zipcode |as_crispy_field }}
                </div>
            </div>

            {{ form.same_billing_address | as_crispy_field}}
            {% comment %} <button class="btn btn-primary float-right" type="submit">Continue</button> {% endcomment %}

            <hr>

            <button class="btn btn-grey float-right" type="submit">Continue to checkout</button>
        </form> 

    </div>
    <!--/.Card-->

</div> 

{% block content %}

<!--Main layout-->
<div class="wow fadeIn">
    <!--Grid row-->

    <div class="row">
    
        <div class="accordion md-accordion col-md-8 mb-4" id="checkout_accordian">

            <!-- Contact -->
            <fieldset class="card rounded-lg" id="contact">
                <div class="d-flex justify-content-between px-3 py-3">
                    <h5 class="mb-0">Contact</h5>
                    <a data-toggle="collapse" data-target="#contactdropdown" >
                        <h5><small>Edit</small></h5>
                    </a>
                </div>
                <div id="contactdropdown" class="collapse px-3 pb-3" data-parent="#checkout_accordian">
                    <form method="post">
                        <div class="row mb-1">
                            <div class="col-md-6">
                                    {{ form.first_name |as_crispy_field }}
                            </div>
                            <div class="col-md-6">
                                    {{ form.last_name|as_crispy_field }}
                            </div>
                        </div>

                        <div class="row mb-1">
                            <div class="col-md-6">
                                    {{ form.email |as_crispy_field }}
                            </div>
                            <div class="col-md-6">
                                    {{ form.phone_number|as_crispy_field }}
                            </div>
                        </div>
                        
                        <button type="submit" class="btn btn-grey btn-sm float-right mb-3 continue_btn">Continue</button>
                    </form>
                </div>
            </fieldset>
            <br>

            <!-- Shipping -->
            <fieldset class="card rounded-lg" id="shipping">
                <div class="d-flex justify-content-between px-3 py-3">
                    <h5 class="mb-0">Shipping</h5>
                    <a data-toggle="collapse" data-target="#shippingdropdown">
                        <h5><small>Edit</small></h5>
                    </a>
                </div>
                <div id="shippingdropdown" class="collapse px-3 pb-3" data-parent="#checkout_accordian">
                    <div class="row mb-1">
                        <!--address-->
                        <div class="col-md-6">
                            {{ form.address1 |as_crispy_field }}
                        </div>

                        <!--address-2-->
                        <div class="col-md-6">
                            {{ form.address2 |as_crispy_field }}
                        </div>
                    </div>

                    <div class="mb-1">
                        {{ form.country |as_crispy_field }}
                    </div>

                    <!--Grid row-->
                    <div class="row mb-1">
                        <div class="col-lg-4 col-md-6">
                            {{ form.city |as_crispy_field }}
                        </div>

                        <div class="col-lg-4 col-md-6">
                            {{ form.state |as_crispy_field }}
                        </div>

                        <div class="col-lg-4 col-md-6">
                            {{ form.zipcode |as_crispy_field }}
                        </div>
                    </div>

                    {{ form.same_billing_address | as_crispy_field}}
                    <button class="btn btn-grey btn-sm float-right mb-3 continue_btn">Continue</button>
                </div>
            </fieldset>
            <br>

            <!-- Payment -->
            <fieldset class="card rounded-lg" id="payment">
                <div class="d-flex justify-content-between px-3 py-3">
                    <h5 class="mb-0">Payment</h5>
                    <a data-toggle="collapse" data-target="#paymentdropdown">
                        <h5><small>Edit</small></h5>
                    </a>
                </div>
                <div id="paymentdropdown" class="collapse px-3 pb-3" data-parent="#checkout_accordian">
                    <div class="wow fadein mb-3" id="paypal-button-container"></div>
                </div>
            </fieldset>
            <br>

            <!-- Review -->
            <fieldset class="card rounded-lg" id="payment">
                <div class="d-flex justify-content-between px-3 py-3">
                    <h5 class="mb-0">Review & Purchase</h5>
                    <a data-toggle="collapse" data-target="#reviewdropdown">
                        <h5><small>Edit</small></h5>
                    </a>
                </div>
                <div id="reviewdropdown" class="collapse px-3 pb-3" data-parent="#checkout_accordian">
                    <h6><small> Please review your order and purchase when you are ready!</small><h6>
                   <button class="btn btn-grey btn-sm float-right mb-3">Purchase</button> 
                </div>
            </fieldset>
            <br>
        </div> 

        <div class="col-md-4 mb-4">

            <!-- Heading -->
            <h4 class="d-flex justify-content-between align-items-center mb-3">
                <span class="text-muted">Your cart</span>
                <span class="badge badge-secondary badge-pill">3</span>
            </h4>

            <!-- Cart -->
            <ul class="list-group mb-3 z-depth-1">
                <li class="list-group-item d-flex justify-content-between lh-condensed">
                    <div>
                        <h6 class="my-0">Product name</h6>
                        <small class="text-muted">Brief description</small>
                    </div>
                    <span class="text-muted">$12</span>
                </li>
                <li class="list-group-item d-flex justify-content-between lh-condensed">
                    <div>
                        <h6 class="my-0">Second product</h6>
                        <small class="text-muted">Brief description</small>
                    </div>
                    <span class="text-muted">$8</span>
                </li>
                <li class="list-group-item d-flex justify-content-between lh-condensed">
                    <div>
                        <h6 class="my-0">Third item</h6>
                        <small class="text-muted">Brief description</small>
                    </div>
                    <span class="text-muted">$5</span>
                </li>
                <li class="list-group-item d-flex justify-content-between bg-light">
                    <div class="text-success">
                        <h6 class="my-0">Promo code</h6>
                        <small>EXAMPLECODE</small>
                    </div>
                    <span class="text-success">-$5</span>
                </li>
                <li class="list-group-item d-flex justify-content-between">
                    <span>Total (USD)</span>
                    <strong>$20</strong>
                </li>
            </ul>
            <!-- Cart -->

            <!-- Promo code -->
            <form class="card p-2">
                <div class="input-group">
                    <input type="text" class="form-control" placeholder="Promo code" aria-label="Recipient's username"
                        aria-describedby="basic-addon2">
                    <div class="input-group-append">
                        <button class="btn btn-secondary btn-md waves-effect m-0" type="button">Redeem</button>
                    </div>
                </div>
            </form>
            <!-- Promo code -->

        </div>

    </div>
    <!--Grid row-->

</div>

<!--Main layout-->

{% endblock content %}



{% block extrascripts %}
    <script
        src="https://www.paypal.com/sdk/js?client-id=AU0iQVK3TE38sF4qX7W5UEVny24GQ1O410iMiNH_hMAH3QiKpaQ5Ih6l1D-wr6AKLtnI38T6o0Lt_G6F&commit=false"> 
    </script>
    <script>
        {% comment %} completeOrder() => {
            var url = "{% url 'complete'%}"
            fetch(url, {
                method: 'POST',
                heards{
                    'Content-type': 'application/json'
                },
                body.JSON.stringify({})
            })
        } {% endcomment %}


        var field_index = 0;
        var fields = $("#checkout_accordian").find("fieldset").get();
        var dropdowns = $("#checkout_accordian").find(".collapse").get();
        var edit_btns = $("#checkout_accordian").find("a").get();

        $(dropdowns[field_index]).collapse("toggle");
        $(edit_btns[field_index]).hide();

        edit_btns.map(btn => {
            $(btn).click( function() {
                $(edit_btns[field_index]).show();
                field_index = fields.findIndex(field => $(field).attr("id") === $(this).closest("fieldset").attr("id"));
                //Hide the previous edit buttons.
                edit_btns.slice(field_index).map(btn => $(btn).hide());
            })
            //Hide all buttons to begin with. 
            $(btn).hide(); 
        });

        $(".continue_btn").click( function() {
            $(edit_btns[field_index]).show();
            field_index++;
            $(dropdowns[field_index]).collapse("toggle");
            $(edit_btns[field_index]).hide();
        });

        paypal.Buttons({
            createOrder: function(data, actions) {
                console.log("{{ order.contact }}");
                console.log("{{ subtotal }}");
                var rtn_order = {
                    intent: 'CAPTURE',
                    payer: {
                        name: {
                            given_name: "{{ order.contact.first_name }}",
                            surname: "{{ order.contact.last_name }}"
                        },
                        email_address: "{{ order.contact.email_address }}",
                        phone: {
                            phone_type: "MOBILE",
                            phone_number: {
                                national_number: "14082508100"
                            }
                        }
                    },
                    purchase_units: [{
                        amount: {
                            value: '{{ subtotal }}',
                            currency_code: 'USD'
                        }
                    }],
                    application_context: {
                        shipping_preference: "NO_SHIPPING"
                    }
                }
                if ({{ order.billing_address|yesno:"true,false" }}){
                    rtn_order.payer.address = {
                        address_line_1: '{{ order.billing_address.address1 }}',
                        address_line_2: '{{ order.billing_address.address2 }}',
                        admin_area_2: '{{ order.billing_address.city }}',
                        admin_area_1: '{{ order.billing_address.state }}',
                        postal_code: '{{ order.billing_address.zipcode }}',
                        country_code: '{{ order.billing_address.country.code }}'                        
                    };
                }

                return actions.order.create(rtn_order);
            },
            onApprove: (data, actions) => {
                // This function captures the funds from the transaction.
                return actions.order.get()
                .then(function(details) {
                    document.querySelector('#confirm-button')
                    .addEventListener('click', function() {
                        return actions.order.capture().then(function(){
                            //Send post request to successful order page. 
                            alert('Transaction completed by ' + details.payer.name.given_name);
                        })
                    })
                });
            },
            onError : function(err) {
                console.log("And error has occured.");
                console.log(error);
                alert("And Error has occured");
            },
            style : {
                shape : "pill",
                color: "blue",
                label: "pay"
            }
        }).render('#paypal-button-container');
        // This function displays Smart Payment Buttons on your web page.
    </script>
{% endblock extrascripts %}
