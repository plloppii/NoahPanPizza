{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block content %}

<!--Main layout-->
<div class="wow fadeIn">
    <!--Grid row-->

    <div class="row">
    
        <div class="accordion md-accordion col-md-8 mb-4" id="checkout_accordian">

            <!-- Contact -->
            <fieldset class="card rounded-lg" id="contact">
                <div class="d-flex justify-content-between px-3 py-3">
                    <h5 class="mb-0">Contact</h5>
                    <a id="contact-form-edit" data-toggle="collapse" data-target="#contact-form" >
                        <h5><small>Edit</small></h5>
                    </a>
                </div>
                <form id="contact-form" class="collapse px-3 pb-3" data-parent="#checkout_accordian" method="POST" >
                    {% csrf_token %}
                    <div class="row mb-1">
                        <div class="col-md-6">
                                {{ form.first_name |as_crispy_field }}
                        </div>
                        <div class="col-md-6">
                                {{ form.last_name|as_crispy_field }}
                        </div>
                    </div>

                    <div class="row mb-1">
                        <div class="col-md-6">
                                {{ form.email |as_crispy_field }}
                        </div>
                        <div class="col-md-6">
                                {{ form.phone_number|as_crispy_field }}
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-grey btn-sm float-right mb-3 continue_btn">Continue</button>
                </form>
                <h6 id="contact-form-info" class="px-5 pb-3" style="white-space: pre-wrap"></h6>
            </fieldset>
            <br>

            <!-- Shipping -->
            <fieldset class="card rounded-lg" id="shipping">
                <div class="d-flex justify-content-between px-3 py-3">
                    <h5 class="mb-0">Shipping</h5>
                    <a id="shipping-form-edit" data-toggle="collapse" data-target="#shipping-form">
                        <h5><small>Edit</small></h5>
                    </a>
                </div>
                <form id="shipping-form" class="collapse px-3 pb-3" data-parent="#checkout_accordian" method="POST">
                    {% csrf_token %}
                    <div class="row mb-1">
                        <!--address-->
                        <div class="col-md-6">
                            {{ form.address1 |as_crispy_field }}
                        </div>

                        <!--address-2-->
                        <div class="col-md-6">
                            {{ form.address2 |as_crispy_field }}
                        </div>
                    </div>

                    <div class="mb-1">
                        {{ form.country |as_crispy_field }}
                    </div>

                    <!--Grid row-->
                    <div class="row mb-1">
                        <div class="col-lg-4 col-md-6">
                            {{ form.city |as_crispy_field }}
                        </div>

                        <div class="col-lg-4 col-md-6">
                            {{ form.state |as_crispy_field }}
                        </div>

                        <div class="col-lg-4 col-md-6">
                            {{ form.zipcode |as_crispy_field }}
                        </div>
                    </div>
                    {{ form.same_billing_address | as_crispy_field}}

                    <button type="submit" class="btn btn-grey btn-sm float-right mb-3 continue_btn">Continue</button>
                </form>
                <h6 id="shipping-form-info" class="px-5 pb-3" style="white-space: pre-wrap"></h6>
            </fieldset>
            <br>

            <!-- Payment -->
            <fieldset class="card rounded-lg" id="payment">
                <div class="d-flex justify-content-between px-3 py-3">
                    <h5 class="mb-0">Payment</h5>
                    <a data-toggle="collapse" data-target="#paypal-button-container">
                        <h5><small>Edit</small></h5>
                    </a>
                </div>
                <div class="wow fadein collapse px-3 pb-3" data-parent="#checkout_accordian" id="paypal-button-container"></div>
            </fieldset>
            <br>

            <!-- Review -->
            <fieldset class="card rounded-lg" id="review">
                <div class="d-flex justify-content-between px-3 py-3">
                    <h5 class="mb-0">Review & Purchase</h5>
                    <a data-toggle="collapse" data-target="#reviewdropdown">
                        <h5><small>Edit</small></h5>
                    </a>
                </div>
                <div id="reviewdropdown" class="collapse px-3 pb-3" data-parent="#checkout_accordian">
                   <h6><small> Please review your order and purchase when you are ready!</small></h6>
                    <div class="d-flex justify-content-end align-items-center">
                        <div class="spinner-border" id="loading-spinner">
                            <span class="sr-only">Loading...</span>
                        </div>
                        <button id="place-order" class="btn btn-grey btn-sm">Purchase</button> 
                    </div>
                </div>
            </fieldset>
            <br>
        </div> 

        <div class="col-md-4 mb-4">

            <!-- Heading -->
            <h4 class="d-flex justify-content-between align-items-center mb-3">
                <span class="text-muted">your cart</span>
                <span class="badge badge-dark badge-pill">{{order.get_total_items}}</span>
            </h4>

            <!-- Cart -->
            <ul class="list-group mb-3 z-depth-1">
                {% for item in order.items.all %}
                    <li class="list-group-item d-flex justify-content-between lh-condensed">
                        <h6 class="my-0">{{item.product.name}} ({{item.quantity}})</h6>
                        <span class="text-muted">{{item.get_subtotal}}</span>
                    </li>
                {% endfor %}
                
                <li class="list-group-item d-flex justify-content-between bg-light">
                    <div class="text-success">
                        <h6 class="my-0">Promo code</h6>
                        <small>EXAMPLECODE</small>
                    </div>
                    <span class="text-success">-$5</span>
                </li>
                <li class="list-group-item d-flex justify-content-between">
                    <span>Total (USD)</span>
                    <strong>{{order.get_subtotal}}</strong>
                </li>
            </ul>
            <!-- Cart -->

            <!-- Promo code -->
            <form class="card p-2">
                <div class="input-group">
                    <input type="text" class="form-control" placeholder="Promo code" aria-label="Recipient's username"
                        aria-describedby="basic-addon2">
                    <div class="input-group-append">
                        <button class="btn btn-grey btn-md waves-effect m-0" type="button">Redeem</button>
                    </div>
                </div>
            </form>
            <!-- Promo code -->

        </div>

    </div>
    <!--Grid row-->

</div>

<!--Main layout-->

{% endblock content %}



{% block extrascripts %}
    <script
        src="https://www.paypal.com/sdk/js?client-id=AU0iQVK3TE38sF4qX7W5UEVny24GQ1O410iMiNH_hMAH3QiKpaQ5Ih6l1D-wr6AKLtnI38T6o0Lt_G6F&commit=false"> 
    </script>
    <script>
        {% comment %} completeOrder() => {
            var url = "{% url 'complete'%}"
            fetch(url, {
                method: 'POST',
                heards{
                    'Content-type': 'application/json'
                },
                body.JSON.stringify({})
            })
        } {% endcomment %}

        class CheckoutProcess{
            constructor(field_elements){
                this.steps = [];
                this.current_index = 0;
                this.paypal_info = {};
                field_elements.map( element => {
                    let step = {
                        id : element.id ,
                        edit_btn : $(element).find("a"),
                        form : $(element).find(".collapse"),
                        info : $(element).find("#"+element.id+"-form-info")
                    }
                    $(step.edit_btn).click( () => {
                        $(step.info).text("");
                        this.current_index =this.steps.findIndex(stp => stp.id === step.id)
                        this.current_step = this.steps[this.current_index];
                        this.steps.slice(this.current_index).map(step => {
                            $(step.edit_btn).hide();
                            $(step.info).text("");
                        });
                    });
                    $(step.edit_btn).hide();
                    $(step.form).on("submit", (e) => {
                        let form_id = "#"+step.id
                        let form_edit = form_id+"-edit"
                        let form_info = form_id+"-info"

                        e.preventDefault();
                        
                        $.ajax({
                            url: "/store/"+step.id+"-form/",
                            type : "POST",
                            data : serializedToJSON($(step.form).serializeArray()),
                            success : (rtn) => {
                                if(!("error" in rtn) ){
                                    $(step.info).text(rtn[step.id+"-text"]);
                                    if(step.id === "contact" || step.id === "shipping"){
                                        this.paypal_info[step.id] = JSON.parse(rtn[step.id]);
                                    }
                                    if("billing" in rtn){
                                        this.paypal_info["billing"] = JSON.parse(rtn["billing"]);
                                    }
                                    this.continue_to_next(); 
                                } else{
                                    alert(rtn["error"]);
                                }
                            },
                            error : (xhr, errmsg, err) => {
                                alert("Something went wrong! Please try again later!\nError: "+xhr.status);
                            }
                        });
                    });
                    this.steps.push(step);
                });
                this.current_step = this.steps[this.current_index];
                $(this.current_step.form).collapse("toggle");
            }
            continue_to_next(){
                $(this.current_step.edit_btn).show()
                this.current_index++;
                this.current_step = this.steps[this.current_index];
                $(this.current_step.form).collapse("toggle");
                $(this.current_step.edit_btn).hide();
            }
        }

        var fields = $("#checkout_accordian").find("fieldset").get();
        var checkout_process = new CheckoutProcess(fields);
        //console.log(checkout_process);

        var subtotal = "{{ subtotal }}";
        //console.log(subtotal);

        $("#loading-spinner").hide();

        paypal.Buttons({
            createOrder: function(data, actions) {
                console.log(checkout_process.paypal_info);
                var order = checkout_process.paypal_info;
                console.log(order.contact.first_name);
                var rtn_order = {
                    intent: 'CAPTURE',
                    payer: {
                        name: {
                            given_name: order.contact.first_name,
                            surname: order.contact.last_name
                        },
                        email_address: order.contact.email_address,
                        phone: {
                            phone_type: "MOBILE",
                            phone_number: {
                                national_number: order.contact.phone_number
                            }
                        }
                    },
                    purchase_units: [{
                        amount: {
                            value: '{{ subtotal }}',
                            currency_code: 'USD'
                        }
                    }],
                    application_context: {
                        shipping_preference: "NO_SHIPPING"
                    }
                }
                if ( order.billing ){
                    let billing_address = checkout_process.paypal_info.shipping;
                    rtn_order.payer.address = {
                        address_line_1: billing_address.address1,
                        address_line_2: billing_address.address2,
                        admin_area_2: billing_address.city,
                        admin_area_1: billing_address.state,
                        postal_code: billing_address.zipcode,
                        country_code: billing_address.country                        
                    };
                } 
                console.log(rtn_order);

                return actions.order.create(rtn_order);
            },
            //Approved, show review dropdown.
            onApprove: (data, actions) => {
                // This function captures the funds from the transaction.
                checkout_process.continue_to_next();
                return actions.order.get()
                .then(function(details) {
                    console.log(details);
                    document.querySelector('#place-order').addEventListener('click', function() {
                        $("#loading-spinner").toggle();
                        return actions.order.capture().then(function(){
                            //Send order information to page to update order with payment information. 
                            $.ajax({
                                url: "/store/checkout-success/order/{{order.id}}",
                                type : "POST",
                                data : { value: JSON.stringify(details)},
                                success : (rtn) => {
                                    if(!("error" in rtn) ){
                                        //alert('Transaction completed by ' + details.payer.name.given_name);
                                        window.location = "/store/checkout-success/order/{{ order.id }}";
                                    } else{
                                        alert("Unable to store order information: "+rtn["error"]);
                                    }
                                },
                                error : (xhr, errmsg, err) => {
                                    alert("Something went wrong! Please try again later!\nError: "+xhr.status);
                                }
                            });
                        })
                    })
                });
            },
            onError : function(err) {
                console.log("And error has occured.");
                alert("An Error has occured! Please review your shipping info");
                console.log(error);
            },
            style : {
                shape : "pill",
                color: "blue",
                label: "pay"
            }
        }).render('#paypal-button-container');
        // This function displays Smart Payment Buttons on your web page.


        function serializedToJSON(arr){
            var rtn = {};
            arr.forEach(obj => rtn[obj.name] = obj.value)
            return rtn;
        }

        // Cookie/ Ajax setup.
        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie != '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = jQuery.trim(cookies[i]);
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) == (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        var csrftoken = getCookie('csrftoken');
        
        /*
        The functions below will create a header with csrftoken
        */

        function csrfSafeMethod(method) {
            // these HTTP methods do not require CSRF protection
            return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
        }
        function sameOrigin(url) {
            // test that a given url is a same-origin URL
            // url could be relative or scheme relative or absolute
            var host = document.location.host; // host + port
            var protocol = document.location.protocol;
            var sr_origin = '//' + host;
            var origin = protocol + sr_origin;
            // Allow absolute or scheme relative URLs to same origin
            return (url == origin || url.slice(0, origin.length + 1) == origin + '/') ||
                (url == sr_origin || url.slice(0, sr_origin.length + 1) == sr_origin + '/') ||
                // or any other URL that isn't scheme relative or absolute i.e relative.
                !(/^(\/\/|http:|https:).*/.test(url));
        }

        $.ajaxSetup({
            beforeSend: function(xhr, settings) {
                if (!csrfSafeMethod(settings.type) && sameOrigin(settings.url)) {
                    // Send the token to same-origin, relative URLs only.
                    // Send the token only if the method warrants CSRF protection
                    // Using the CSRFToken value acquired earlier
                    xhr.setRequestHeader("X-CSRFToken", csrftoken);
                }
            }
        });
    </script>
{% endblock extrascripts %}
